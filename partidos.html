<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Partidos - Rugby Veteranos</title>
  <style>
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .btn-accion { padding: 4px 8px; margin: 2px; cursor: pointer; }
    .event-img { width: 60px; height: 60px; object-fit: cover; }
  </style>
</head>
<body>

<h2>Crear Evento</h2>
<form id="formCrearEvento">
  <input type="text" id="titulo" placeholder="Título" required>
  <input type="datetime-local" id="fecha" placeholder="Fecha" required>
  <input type="datetime-local" id="fechaVencimiento" placeholder="Vencimiento Confirmación">
  <input type="text" id="direccion" placeholder="Dirección">
  <input type="text" id="numero" placeholder="Número">
  <input type="text" id="ciudad" placeholder="Ciudad">
  <input type="text" id="provincia" placeholder="Provincia">
  <input type="text" id="pais" placeholder="País">
  <input type="text" id="clubOrganizador" placeholder="Club Organizador">
  <input type="file" id="eventoImagen" accept="image/*">
  <input type="number" id="costoTotal" placeholder="Costo Total" step="0.01">
  <label><input type="checkbox" id="inviteAll"> Invitar a todos</label>
  <button type="button" id="crearEventoBtn">Crear Evento</button>
</form>

<h2>Invitaciones</h2>
<table>
  <thead>
    <tr>
      <th>Imagen</th>
      <th>Evento</th>
      <th>Tipo</th>
      <th>Fecha</th>
      <th>Vencimiento Confirmación</th>
      <th>Lugar</th>
      <th>Club Organizador</th>
      <th>Invitados</th>
      <th>Costo Total</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="misInvitaciones"></tbody>
</table>

<h2>Eventos Activos</h2>
<table>
  <thead>
    <tr>
      <th>Imagen</th>
      <th>Evento</th>
      <th>Tipo</th>
      <th>Fecha</th>
      <th>Vencimiento Confirmación</th>
      <th>Lugar</th>
      <th>Club Organizador</th>
      <th>Invitados</th>
      <th>Costo Total</th>
      <th>Participantes Confirmados</th>
      <th>Pagos Generados</th>
    </tr>
  </thead>
  <tbody id="eventosActivos"></tbody>
</table>

<h2>Eventos Inactivos</h2>
<table>
  <thead>
    <tr>
      <th>Imagen</th>
      <th>Evento</th>
      <th>Tipo</th>
      <th>Fecha</th>
      <th>Vencimiento Confirmación</th>
      <th>Lugar</th>
      <th>Club Organizador</th>
      <th>Invitados</th>
      <th>Costo Total</th>
      <th>Participantes Confirmados</th>
      <th>Pagos Generados</th>
    </tr>
  </thead>
  <tbody id="eventosInactivos"></tbody>
</table>

<script>
/* ----------------- Helpers ----------------- */
function normalizeEvent(raw) {
  const ev = {};
  for (const k in raw) {
    if (!raw.hasOwnProperty(k)) continue;
    const nk = k.toString()
                .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                .toLowerCase().replace(/\s+/g,'');
    ev[nk] = raw[k];
  }
  return {
    id: ev.id || ev.idevento || ev.idevent || ev.eventid || ev.id,
    imagen: ev.imagen || ev.image || '',
    titulo: ev.evento || ev.titulo || ev.title || '',
    tipo: ev.tipo || '',
    fecha: ev.fecha || '',
    fechavencimientoconfirmacion: ev.fechavencimientoconfirmacion || ev.fechavencimiento || '',
    direccion: ev.direccion || '',
    numero: ev.numero || '',
    ciudad: ev.ciudad || '',
    provincia: ev.provincia || '',
    pais: ev.pais || '',
    cluborganizador: ev.cluborganizador || '',
    invitados: ev.invitados || '',
    costototal: ev.costototal || '',
    participantesconfirmados: ev.participantesconfirmados || '',
    pagosgenerados: ev.pagosgenerados || '',
    estadoinvitacion: ev.estadoinvitacion || ev.estado || '',
    _raw: raw
  };
}

function crearFilaEvento(evNorm, conAcciones=false){
  const tr = document.createElement('tr');
  const lugar = [evNorm.direccion, evNorm.numero, evNorm.ciudad, evNorm.provincia, evNorm.pais].filter(x => x).join(', ');
  const fechaText = evNorm.fecha ? (new Date(evNorm.fecha).toLocaleString()) : '';
  const fechaVencText = evNorm.fechavencimientoconfirmacion ? (new Date(evNorm.fechavencimientoconfirmacion).toLocaleString()) : '';
  const idAttr = evNorm.id || '';
  const imgHtml = evNorm.imagen ? `<img src="${evNorm.imagen}" class="event-img" />` : '';

  if(conAcciones){
    tr.innerHTML = `
      <td>${imgHtml}</td>
      <td>${evNorm.titulo}</td>
      <td>${evNorm.tipo}</td>
      <td>${fechaText}</td>
      <td>${fechaVencText}</td>
      <td>${lugar}</td>
      <td>${evNorm.cluborganizador}</td>
      <td>${evNorm.invitados}</td>
      <td>${evNorm.costototal}</td>
      <td>
        <button class="btn-accion" onclick="responderInvitacion('${idAttr}', 'Aceptado')">✅ Aceptar</button>
        <button class="btn-accion" onclick="responderInvitacion('${idAttr}', 'Rechazado')">❌ Rechazar</button>
      </td>
    `;
  } else {
    tr.innerHTML = `
      <td>${imgHtml}</td>
      <td>${evNorm.titulo}</td>
      <td>${evNorm.tipo}</td>
      <td>${fechaText}</td>
      <td>${fechaVencText}</td>
      <td>${lugar}</td>
      <td>${evNorm.cluborganizador}</td>
      <td>${evNorm.invitados}</td>
      <td>${evNorm.costototal}</td>
      <td>${evNorm.participantesconfirmados}</td>
      <td>${evNorm.pagosgenerados}</td>
    `;
  }

  tr.dataset.eventId = idAttr;
  tr._evNorm = evNorm;
  return tr;
}

/* ----------------- Listar Eventos ----------------- */
async function listarEventos(){
  try {
    const res = await fetch('/.netlify/functions/listarEventos');
    if(!res.ok) throw new Error('Error al listar eventos: '+res.status);
    const raw = await res.json();
    const eventos = raw.map(normalizeEvent);

    const tbodyActivos = document.getElementById('eventosActivos');
    const tbodyInvitaciones = document.getElementById('misInvitaciones');
    const tbodyInactivos = document.getElementById('eventosInactivos');
    tbodyActivos.innerHTML=''; tbodyInvitaciones.innerHTML=''; tbodyInactivos.innerHTML='';

    const hoy = new Date();

    eventos.forEach(ev=>{
      const fechaEvento = ev.fecha ? new Date(ev.fecha) : null;
      const estado = (ev.estadoinvitacion || '').toLowerCase();

      if(estado==='rechazado' || (fechaEvento && fechaEvento<hoy)){
        tbodyInactivos.appendChild(crearFilaEvento(ev));
      } else if(estado==='aceptado' || ev.participantesconfirmados){
        tbodyActivos.appendChild(crearFilaEvento(ev));
      } else {
        tbodyInvitaciones.appendChild(crearFilaEvento(ev, true));
      }
    });

  } catch(err){
    console.error(err);
  }
}

/* ----------------- Crear Evento ----------------- */
async function crearEvento(){
  try {
    const fileInput = document.getElementById('eventoImagen');
    let imageUrl = '';

    if(fileInput && fileInput.files.length>0){
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('image', file);
      formData.append('key', '5e7ff6621fb603a7835a4b4ec45fd4eb'); // reemplazar con tu key
      const res = await fetch('https://api.imgbb.com/1/upload', { method:'POST', body:formData });
      const data = await res.json();
      imageUrl = data?.data?.url || '';
    }

    const datos = {
      action:'crearEvento',
      titulo: document.getElementById('titulo').value,
      fecha: document.getElementById('fecha').value,
      fechaVencimiento: document.getElementById('fechaVencimiento').value,
      direccion: document.getElementById('direccion').value,
      numero: document.getElementById('numero').value,
      ciudad: document.getElementById('ciudad').value,
      provincia: document.getElementById('provincia').value,
      pais: document.getElementById('pais').value,
      clubOrganizador: document.getElementById('clubOrganizador').value,
      invitados: document.getElementById('inviteAll').checked ? 'Todos' : '',
      imagen: imageUrl,
      costoTotal: document.getElementById('costoTotal').value
    };

    const res = await fetch('/.netlify/functions/crearEvento', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(datos)
    });

    const result = await res.json();
    if(result.status==='ok'){
      alert('Evento creado con éxito');
      listarEventos();
      document.getElementById('formCrearEvento').reset();
    } else {
      alert('Error al crear evento: '+JSON.stringify(result));
    }

  } catch(err){
    console.error('Error crearEvento:', err);
    alert('Error de conexión. Ver consola.');
  }
}

/* ----------------- Responder Invitación ----------------- */
async function responderInvitacion(idEvento, estado){
  try{
    const res = await fetch('/.netlify/functions/responderInvitacion', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ idEvento, estado })
    });
    const data = await res.json();
    if(data.status==='ok'){
      listarEventos();
    } else {
      alert('Error: '+JSON.stringify(data));
    }
  } catch(err){
    console.error('Error responderInvitacion:', err);
    alert('Error al responder invitación. Ver consola.');
  }
}

/* ----------------- Inicialización ----------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('crearEventoBtn').addEventListener('click', crearEvento);
  listarEventos();
});
</script>
</body>
</html>




