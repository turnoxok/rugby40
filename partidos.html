<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Partidos/Eventos - Rugby Veteranos</title>
<link rel="icon" type="image/x-icon" href="./favicon.ico">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
  body { display: flex; min-height: 100vh; background: #f5f6fa; }
  .sidebar { width: 250px; background: #2c3e50; color: #ecf0f1; padding: 20px; }
  .sidebar h2 { margin-bottom: 30px; font-size: 20px; }
  .sidebar ul { list-style: none; }
  .sidebar ul li { margin: 15px 0; }
  .sidebar ul li a { color: #ecf0f1; text-decoration: none; display: block; padding: 8px 10px; border-radius: 6px; }
  .sidebar ul li a:hover { background: #34495e; }
  .main { flex: 1; padding: 20px; }
  .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .topbar h1 { font-size: 24px; color: #2c3e50; }
  .card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .card h3 { margin-bottom: 15px; font-size: 18px; color: #2c3e50; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
  .btn { background: #27ae60; color: white; padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; }
  .btn:hover { background: #219150; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #ecf0f1; }
  img.event-img { max-width: 120px; max-height: 80px; border-radius: 4px; }
</style>
</head>
<body>

<div class="sidebar">
  <h2>Mi Club</h2>
  <ul>
    <li><a href="admin.html">üè† Dashboard</a></li>
    <li><a href="#" onclick="showSection('crear')">‚ûï Crear Evento</a></li>
    <li><a href="#" onclick="showSection('lista')">üìã Lista de Eventos</a></li>
    <li><a href="#" onclick="logout()">Salir</a></li>
  </ul>
</div>

<div class="main">
  <div class="topbar">
    <h1>Partidos/Eventos</h1>
  </div>

  <!-- CREAR EVENTO -->
  <div class="card" id="section-crear">
    <h3>Crear Evento</h3>

    <div class="form-group">
      <label>T√≠tulo del Evento</label>
      <input type="text" id="titulo" placeholder="Encuentro vs Club XYZ">
    </div>

    <div class="form-group">
      <label>Tipo de Evento</label>
      <select id="eventType" onchange="toggleEventType()">
        <option value="propio">Propio</option>
        <option value="tercero">Tercero</option>
      </select>
    </div>

    <div class="form-group" id="clubOrganizerGroup" style="display:none">
      <label>Club Organizador</label>
      <input type="text" id="clubOrganizador" placeholder="Nombre del club externo">
    </div>

    <div class="form-group" id="inviteClubsGroup">
      <label>Enviar invitaci√≥n a clubes</label>
      <input type="checkbox" id="inviteAll"> Todos los clubes registrados
      <select multiple id="selectClubs" style="margin-top:5px;">
        <option>Club A</option>
        <option>Club B</option>
        <option>Club C</option>
      </select>
    </div>

    <h4>Ubicaci√≥n del Evento</h4>
    <div class="form-group"><label>Direcci√≥n</label><input type="text" id="direccion"></div>
    <div class="form-group"><label>N√∫mero</label><input type="text" id="numero"></div>
    <div class="form-group"><label>Ciudad</label><input type="text" id="ciudad"></div>
    <div class="form-group"><label>Provincia</label><select id="provincia"><option>Provincia 1</option><option>Provincia 2</option><option>Provincia 3</option></select></div>
    <div class="form-group"><label>Pa√≠s</label><select id="pais"><option>Argentina</option><option>Brasil</option><option>Uruguay</option></select></div>

    <div class="form-group"><label>Fecha y Hora</label><input type="datetime-local" id="fecha"></div>
    <div class="form-group"><label>Costo Total</label><input type="number" id="costoTotal" placeholder="0"></div>

    <div class="form-group">
      <label>Imagen del Evento</label>
      <input type="file" id="eventoImagen" accept="image/*">
    </div>

    <button class="btn" onclick="crearEvento()">Crear Evento</button>
  </div>

  <!-- LISTA DE EVENTOS -->
  <div class="card" id="section-lista" style="display:none">
    <h3>Lista de Eventos</h3>
    <table id="eventTable">
      <thead>
        <tr>
          <th>Imagen</th>
          <th>T√≠tulo</th>
          <th>Tipo</th>
          <th>Fecha</th>
          <th>Lugar</th>
          <th>Jugadores Confirmados</th>
          <th>Pagos</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
function toggleEventType(){
  const type = document.getElementById('eventType').value;
  document.getElementById('clubOrganizerGroup').style.display = (type==='tercero')?'block':'none';
  document.getElementById('inviteClubsGroup').style.display = (type==='propio')?'block':'none';
}

function showSection(sec){
  ['crear','lista'].forEach(s => {
    document.getElementById('section-'+s).style.display = (s===sec)?'block':'none';
  });
}

function logout(){ window.location.href = 'admin.html'; }

async function crearEvento(){
  const fileInput = document.getElementById('eventoImagen');
  let imageUrl = '';

  if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('image', file);
    formData.append('key', '5e7ff6621fb603a7835a4b4ec45fd4eb'); // <--- PONER TU API KEY DE IMGBB

    try{
      const res = await fetch('https://api.imgbb.com/1/upload', { method:'POST', body: formData });
      const data = await res.json();
      imageUrl = data.data.url;
      console.log('Imagen subida a imgbb:', imageUrl);
    } catch(err){
      console.error('Error subiendo imagen a imgbb:', err);
      alert('No se pudo subir la imagen. Intenta nuevamente.');
      return;
    }
  }

  const datos = {
    action: 'crearEvento',
    titulo: document.getElementById('titulo').value,
    fecha: document.getElementById('fecha').value,
    direccion: document.getElementById('direccion').value,
    numero: document.getElementById('numero').value,
    ciudad: document.getElementById('ciudad').value,
    provincia: document.getElementById('provincia').value,
    pais: document.getElementById('pais').value,
    tipo: document.getElementById('eventType').value,
    clubOrganizador: document.getElementById('clubOrganizador').value,
    invitados: document.getElementById('inviteAll').checked ? 'Todos' : Array.from(document.getElementById('selectClubs').selectedOptions).map(o => o.value).join(','),
    imagen: imageUrl
  };

  console.log('Datos a enviar a Netlify Function:', datos);

  fetch('/.netlify/functions/crearEvento', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(datos)
  })
  .then(res => res.json())
  .then(res => {
    console.log('Respuesta final de la funci√≥n:', res);
    if(res.status==='ok') alert('Evento creado exitosamente');
    else alert('Error al crear evento: ' + JSON.stringify(res));
  })
  .catch(err => {
    console.error('Error en fetch:', err);
    alert('Error de conexi√≥n. Intente nuevamente.');
  });
}

 async function listarEventos() {
  try {
    const response = await fetch('/.netlify/functions/listarEventos', { method: 'GET' });
    const eventos = await response.json();

    const tbody = document.querySelector('#eventTable tbody');
    tbody.innerHTML = '';

    eventos.forEach(ev => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${ev.titulo}</td>
        <td>${ev.tipo}</td>
        <td>${new Date(ev.fecha).toLocaleString()}</td>
        <td>${ev.direccion} ${ev.numero}, ${ev.ciudad}, ${ev.provincia}, ${ev.pais}</td>
        <td>${ev.ParticipantesConfirmados || ''}</td>
        <td>${ev.PagosGenerados || ''}</td>
        <td>${ev.imagen ? `<img src="${ev.imagen}" style="width:100px; height:auto;" />` : ''}</td>
      `;
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error('Error al listar eventos:', err);
  }
}

// Ejecutar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', listarEventos);

</script>

</body>
</html>
