<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Micrositio Club Rugby</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* --- Loader --- */
#loader {
  position: fixed; top:0; left:0; width:100%; height:100%;
  display:flex; justify-content:center; align-items:center;
  background:rgba(255,255,255,0.8); z-index:9999; display:none;
}
.loader-rugby {
  width:60px; height:35px; background:#3498db;
  border-radius:50%/50%;
  transform:rotate(45deg);
  animation: spinRugby 1s linear infinite, brightnessRugby 2s ease-in-out infinite alternate;
}
@keyframes spinRugby { 0% { transform:rotate(45deg);} 100% { transform:rotate(405deg);} }
@keyframes brightnessRugby { 0% {filter:brightness(0.8);} 100% {filter:brightness(1.2);} }

/* --- Modal --- */
.modal {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6); display:none;
  justify-content:center; align-items:center; z-index:10000;
}
.modal-content {
  background:#fff; padding:30px; border-radius:15px; width:90%; max-width:400px;
  box-shadow:0 8px 25px rgba(0,0,0,0.3); position:relative;
  animation: fadeInModal 0.3s ease;
}
@keyframes fadeInModal { from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);} }
.close-modal { position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer; }

/* --- Hero / Parallax --- */
.hero { position:relative; overflow:hidden; width:100%; height:60vh; }
.hero img { position:absolute; top:0; left:50%; transform:translateX(-50%); width:100%; height:auto; transition: transform 0.2s, filter 0.3s; }

/* --- Secciones --- */
section { opacity:0; transform:translateY(30px); transition:all 0.6s ease; }
section.visible { opacity:1; transform:translateY(0); }

/* --- Texto animado --- */
.fade-word { opacity:0; display:inline-block; transition:opacity 0.5s ease; }
.fade-word.visible { opacity:1; }

/* --- Botones --- */
button { background:#3498db; color:#fff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; transition:background 0.3s; }
button:hover { background:#2980b9; }

/* --- Navbar --- */
.navbar { display:flex; justify-content:space-between; align-items:center; padding:15px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.1); position:sticky; top:0; z-index:1000; }
.navbar button { margin-left:10px; }
</style>

</head>
<body>

<div id="loader"><div class="loader-rugby"></div></div>

<!-- Navbar -->
<div class="navbar">
  <h2 id="clubLogo">Club Rugby</h2>
  <div>
    <button id="loginBtn">Login Admin</button>
    <button id="guardarBtn" style="display:none;">Guardar Cambios</button>
  </div>
</div>

<!-- Hero -->
<div class="hero">
  <img id="portadaImg" src="" alt="Portada Club">
</div>

<!-- Descripción -->
<section>
  <h2>Descripción</h2>
  <p id="descripcionClub"></p>
</section>

<!-- Partidos -->
<section>
  <h2>Partidos</h2>
  <div id="listaPartidos"></div>
</section>

<!-- Modal Login -->
<div id="modalLogin" class="modal">
  <div class="modal-content">
    <span class="close-modal" id="cerrarModal">&times;</span>
    <h3>Login Admin</h3>
    <input type="password" id="inputAdminPass" placeholder="Contraseña" style="width:100%; margin:10px 0; padding:10px; border-radius:6px; border:1px solid #ccc;">
    <button id="btnIngresarAdmin">Ingresar</button>
    <button id="btnRecuperarPass">Recuperar contraseña</button>
  </div>
</div>

<!-- Modal Perfil (solo lectura si no logueado) -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <span class="close-modal" id="closeModal">&times;</span>
    <h3>Perfil Club</h3>
    <label>Nombre</label><input id="perfilNombre"><br>
    <label>Dirección</label><input id="perfilDireccion"><br>
    <label>Teléfono</label><input id="perfilTelefono"><br>
    <label>Descripción</label><textarea id="perfilDescripcion"></textarea><br>
    <label>WhatsApp</label><input id="perfilWhatsapp"><br>
    <label>Instagram</label><input id="perfilInstagram"><br>
    <label>Portada</label><input id="perfilPortada"><br>
  </div>
</div>

  <script>
// -------- Variables y elementos --------
const API_URL = "/.netlify/functions/api";
const username = window.location.pathname.slice(1);

const perfilNombre = document.getElementById("perfilNombre");
const perfilDireccion = document.getElementById("perfilDireccion");
const perfilTelefono = document.getElementById("perfilTelefono");
const perfilDescripcion = document.getElementById("perfilDescripcion");
const perfilWhatsapp = document.getElementById("perfilWhatsapp");
const perfilInstagram = document.getElementById("perfilInstagram");
const perfilPortada = document.getElementById("perfilPortada");

const loginBtn = document.getElementById("loginBtn");
const guardarBtn = document.getElementById("guardarBtn");
const portadaImg = document.getElementById("portadaImg");
const descripcionClub = document.getElementById("descripcionClub");
const clubLogo = document.getElementById("clubLogo");
const listaPartidos = document.getElementById("listaPartidos");
const loader = document.getElementById("loader");

const modalLogin = document.getElementById("modalLogin");
const inputAdminPass = document.getElementById("inputAdminPass");
const btnIngresarAdmin = document.getElementById("btnIngresarAdmin");
const btnRecuperarPass = document.getElementById("btnRecuperarPass");
const cerrarModal = document.getElementById("cerrarModal");

const profileModal = document.getElementById("profileModal");
const closeModal = document.getElementById("closeModal");
const modalLoader = document.getElementById("modalLoader");

let loggedAsAdmin = false;

// -------- Funciones util --------
function bloquearInputs(){ [perfilNombre, perfilDireccion, perfilTelefono, perfilDescripcion, perfilWhatsapp, perfilInstagram, perfilPortada].forEach(i=>i.disabled=true); }
function desbloquearInputs(){ [perfilNombre, perfilDireccion, perfilTelefono, perfilDescripcion, perfilWhatsapp, perfilInstagram, perfilPortada].forEach(i=>i.disabled=false); }

function animarTexto(element){
  const text = element.innerText.trim();
  element.innerHTML = text.split(' ').map(w=>`<span class="fade-word">${w}</span>`).join(' ');
  element.querySelectorAll('.fade-word').forEach((word,i)=>setTimeout(()=>word.classList.add('visible'), i*100));
}

function ajustarHero(){ 
  if (!portadaImg.complete || portadaImg.naturalWidth===0) return;
  const imgRatio = portadaImg.naturalHeight/portadaImg.naturalWidth;
  document.querySelector(".hero").style.height = (window.innerWidth*imgRatio)+"px";
}

// -------- Event Listeners --------
window.addEventListener("scroll", ()=>{
  document.querySelectorAll("section").forEach(sec=>{ if(sec.getBoundingClientRect().top<window.innerHeight-100) sec.classList.add("visible"); });
  if(window.innerWidth>768) portadaImg.style.transform=`translateY(${window.scrollY*0.2}px) translateX(-50%)`;
  else portadaImg.style.transform=`translateY(0) translateX(-50%)`;
});
portadaImg.addEventListener("load", ajustarHero);
window.addEventListener("resize", ajustarHero);

loginBtn.addEventListener("click", ()=>modalLogin.style.display="flex");
cerrarModal.addEventListener("click", ()=>modalLogin.style.display="none");
closeModal.addEventListener("click", ()=>profileModal.style.display="none");

// -------- Cargar Perfil y Partidos --------
async function cargarClub(){
  loader.style.display="flex";
  try{
    const [resPerfil,resPartidos] = await Promise.all([
      fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"obtenerPerfilClub",username})}),
      fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"listarEventos"})})
    ]);
    const dataPerfil = await resPerfil.json();
    if(dataPerfil.status==="ok"){
      const p=dataPerfil.perfil;
      clubLogo.textContent = p.NombreClub||"Club Rugby";
      descripcionClub.textContent = p.Descripción||"";
      animarTexto(descripcionClub);
      portadaImg.src = p.Portada||"";
      perfilNombre.value = p.NombreClub||"";
      perfilDireccion.value = p.Dirección||"";
      perfilTelefono.value = p.Teléfono||"";
      perfilDescripcion.value = p.Descripción||"";
      perfilWhatsapp.value = p.WhatsApp||"";
      perfilInstagram.value = p.Instagram||"";
      perfilPortada.value = p.Portada||"";
    }
    const rawPartidos = await resPartidos.json();
    const hoy = new Date();
    const partidosNorm = rawPartidos.map(raw=>{
      const ev={}; for(const k in raw){ if(!raw.hasOwnProperty(k)) continue;
      const nk=k.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\s+/g,''); ev[nk]=raw[k]; }
      return { id:ev.id||ev.idevento||ev.id, cluborganizador:ev.cluborganizador||'', estadoinvitacion:ev.estadoinvitacion||ev.estado||'', fecha:ev.fecha||'', lugar:ev.lugar||'', imagen:ev.imagen||'', _raw:raw };
    });
    const partidosFiltrados = partidosNorm.filter(p=>{ const estado=(p.estadoinvitacion||'').toLowerCase(); const fechaEvento=p.fecha?new Date(p.fecha):null; return estado==='aceptado' && (!fechaEvento||fechaEvento>=hoy); });
    listaPartidos.innerHTML = partidosFiltrados.length===0? "<p>No hay partidos activos.</p>" : partidosFiltrados.map(p=>`<div class="partido-card"><img src="${p.imagen||'https://via.placeholder.com/600x300'}"><div><h3>${p.cluborganizador||'Club'}</h3><p>Fecha: ${p.fecha}</p><p>Lugar: <a href="https://maps.google.com/?q=${encodeURIComponent(p.lugar)}" target="_blank">${p.lugar}</a></p></div></div>`).join('');
  } catch(err){ console.error(err); listaPartidos.innerHTML="<p>Error al cargar club o partidos.</p>"; }
  finally{ loader.style.display="none"; }
}

// -------- Login Admin --------
btnIngresarAdmin.addEventListener("click", async ()=>{
  const pass=inputAdminPass.value; if(!pass) return;
  try{
    const res = await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"loginClub",username,password:pass})});
    const data = await res.json();
    if(data.status==="ok"){
      alert("Bienvenido Admin");
      desbloquearInputs(); loggedAsAdmin=true; profileModal.style.display="flex"; guardarBtn.style.display="inline-block"; modalLogin.style.display="none";
    } else alert("Contraseña incorrecta");
  } catch(err){ console.error(err); alert("Error al loguear"); }
});
btnRecuperarPass.addEventListener("click", ()=>alert("Se enviará un correo de recuperación (simulado)."));

// -------- Guardar cambios --------
guardarBtn.addEventListener("click", async ()=>{
  if(!loggedAsAdmin){ alert("Debe iniciar sesión como admin"); return; }
  loader.style.display="flex";
  const perfil = { username, NombreClub:perfilNombre.value, Dirección:perfilDireccion.value, Teléfono:perfilTelefono.value, Descripción:perfilDescripcion.value, WhatsApp:perfilWhatsapp.value, Instagram:perfilInstagram.value, Portada:perfilPortada.value };
  try{
    const res = await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"actualizarPerfilClub", ...perfil})});
    const data = await res.json();
    loader.style.display="none";
    if(data.status==="ok"){ alert("Perfil guardado correctamente"); portadaImg.src=perfil.Portada; window.location.reload(); }
    else alert("Error: "+data.msg);
  } catch(err){ loader.style.display="none"; alert("Error al guardar: "+err.message); }
});

// -------- Inicial --------
bloquearInputs();
cargarClub();
</script>


</body>
</html>
