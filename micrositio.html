<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Micrositio Club Rugby</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
* { box-sizing:border-box; margin:0; padding:0; font-family:'Poppins', sans-serif; scroll-behavior:smooth; }
body { background:#f5f6fa; color:#333; }

/* Navbar */
.navbar { position:fixed; top:0; width:100%; background:rgba(255,255,255,0.95); display:flex; justify-content:space-between; align-items:center; padding:15px 20px; z-index:1000; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.navbar .logo { font-weight:700; font-size:1.3em; color:#27ae60; }
.navbar ul { list-style:none; display:flex; gap:20px; }
.navbar ul li a { text-decoration:none; color:#333; font-weight:500; transition:0.3s; }
.navbar ul li a:hover { color:#27ae60; }
.hamburger { display:none; font-size:1.5em; cursor:pointer; }
.navbar ul.mobile { display:none; flex-direction:column; position:absolute; top:60px; right:20px; background:#fff; border-radius:8px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.2); animation:fadeIn 0.3s; }

/* Hero / Portada */
.hero { position:relative; width:100%; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.hero img { padding-top:60px; width:100%; height:auto; object-fit:cover; transition:0.5s; }
.hero h1 { position:absolute; color:#fff; font-size:3em; text-shadow:2px 2px 8px rgba(0,0,0,0.7); text-align:center; }

/* Sections */
section { max-width:900px; margin:100px auto; padding:50px 20px; opacity:0; transform:translateY(50px); transition:all 0.8s ease; }
section.visible { opacity:1; transform:translateY(0); }

/* Quiénes somos */
#quienesSomos img { width:100%; border-radius:8px; margin-top:20px; }

/* Partidos */
.partido { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; transition:0.3s; }
.partido:hover { transform:translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }

/* Contacto */
.contacto { display:flex; gap:20px; font-size:1.2em; margin-top:20px; }
.contacto a { color:#333; transition:0.3s; }
.contacto a:hover { color:#27ae60; }

/* Map */
.map-container { margin-top:20px; width:100%; height:400px; border-radius:8px; overflow:hidden; }

/* Form Admin */
.container { max-width:800px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
label { font-weight:bold; display:block; margin-top:10px; }
input, textarea { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
button { margin-top:15px; padding:10px 15px; border:none; background:#27ae60; color:#fff; border-radius:6px; cursor:pointer; }
button:hover { background:#219150; }

/* Animaciones */
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

/* Responsive */
@media(max-width:768px){
  .navbar ul { display:none; }
  .hamburger { display:block; }
  .navbar ul.mobile.show { display:flex; }
  .hero h1 { font-size:2em; padding:0 20px; }
}

  /* Tarjetas de partidos */
.partido-card {
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  overflow:hidden;
  margin-bottom:20px;
  transition:transform 0.3s, box-shadow 0.3s;
  display:flex;
  flex-direction:column;
}
.partido-card:hover {
  transform:translateY(-5px);
  box-shadow:0 6px 14px rgba(0,0,0,0.15);
}
.partido-card img {
  width:100%;
  height:180px;
  object-fit:cover;
}
.partido-info {
  padding:15px;
}
.partido-info h3 {
  margin-bottom:8px;
  font-size:1.2em;
  color:#27ae60;
}
.partido-info p {
  margin:5px 0;
}
.partido-info a {
  color:#2980b9;
  text-decoration:none;
}
.partido-info a:hover {
  text-decoration:underline;
}

</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="logo" id="clubLogo">Club Rugby</div>
  <ul id="menu">
    <li><a href="#quienesSomos">Quiénes Somos</a></li>
    <li><a href="#portada">Portada</a></li>
    <li><a href="#partidos">Próximos Partidos</a></li>
    <li><a href="#contacto">Contacto</a></li>
  </ul>
  <div class="hamburger" id="hamburger">&#9776;</div>
  <ul class="mobile" id="mobileMenu"></ul>
</nav>

<!-- Hero / Portada -->
<div class="hero" id="portada">
  <img id="portadaImg" src="" alt="Portada">
  <h1 id="clubName">Cargando club...</h1>
</div>

<!-- Quiénes somos -->
<section id="quienesSomos">
  <h2>Quiénes Somos</h2>
  <p id="descripcionClub"></p>
</section>

<!-- Partidos -->
<section id="partidos">
  <h2>Próximos Partidos</h2>
  <div id="listaPartidos"></div>
</section>

<!-- Contacto -->
<section id="contacto">
  <h2>Contacto</h2>
  <div class="contacto">
    <a href="#" id="telLink"><i class="fas fa-phone"></i> Teléfono</a>
    <a href="#" id="whatsappLink"><i class="fab fa-whatsapp"></i> WhatsApp</a>
    <a href="#" id="instagramLink"><i class="fab fa-instagram"></i> Instagram</a>
  </div>
  <div class="map-container">
    <iframe id="mapa" src="" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
  </div>
</section>

<!-- Admin Form -->
<div class="container" id="profileContainer">
  <h2>Editar Perfil del Club</h2>
  <label>Nombre del Club</label>
  <input type="text" id="perfilNombre">
  <label>Dirección</label>
  <input type="text" id="perfilDireccion">
  <label>Teléfono</label>
  <input type="text" id="perfilTelefono">
  <label>Quiénes somos</label>
  <textarea id="perfilDescripcion" rows="4"></textarea>
  <label>WhatsApp</label>
  <input type="text" id="perfilWhatsapp">
  <label>Instagram</label>
  <input type="text" id="perfilInstagram">
  <label>Portada (URL)</label>
  <input type="text" id="perfilPortada">
  <button id="loginBtn">Acceso Admin</button>
  <button id="guardarBtn">Guardar Perfil</button>
</div>

<script>
const API_URL = "/.netlify/functions/api";
const path = window.location.pathname;   
const username = path.slice(1);          

// Elementos
const perfilNombre = document.getElementById("perfilNombre");
const perfilDireccion = document.getElementById("perfilDireccion");
const perfilTelefono = document.getElementById("perfilTelefono");
const perfilDescripcion = document.getElementById("perfilDescripcion");
const perfilWhatsapp = document.getElementById("perfilWhatsapp");
const perfilInstagram = document.getElementById("perfilInstagram");
const perfilPortada = document.getElementById("perfilPortada");
const clubName = document.getElementById("clubName");
const loginBtn = document.getElementById("loginBtn");
const guardarBtn = document.getElementById("guardarBtn");
const portadaImg = document.getElementById("portadaImg");
const descripcionClub = document.getElementById("descripcionClub");
const clubLogo = document.getElementById("clubLogo");
const telLink = document.getElementById("telLink");
const whatsappLink = document.getElementById("whatsappLink");
const instagramLink = document.getElementById("instagramLink");
const mapa = document.getElementById("mapa");
const listaPartidos = document.getElementById("listaPartidos");

// Navbar móvil
const hamburger = document.getElementById("hamburger");
const mobileMenu = document.getElementById("mobileMenu");
hamburger.addEventListener("click", ()=>{ mobileMenu.classList.toggle("show"); });

let loggedAsAdmin = false;

// Bloquear/Desbloquear inputs
function bloquearInputs(){
  [perfilNombre, perfilDireccion, perfilTelefono, perfilDescripcion, perfilWhatsapp, perfilInstagram, perfilPortada].forEach(i=>i.disabled=true);
}
function desbloquearInputs(){
  [perfilNombre, perfilDireccion, perfilTelefono, perfilDescripcion, perfilWhatsapp, perfilInstagram, perfilPortada].forEach(i=>i.disabled=false);
}


// Cargar club y partidos
async function cargarClub() {
  try {
    // 1️⃣ Perfil del club
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "obtenerPerfilClub", username })
    });

    const data = await res.json();
    console.log("Respuesta perfil club:", data);

    if (data.status === "ok") {
      const p = data.perfil;

      // Rellenar campos del perfil
      clubName.textContent = p.NombreClub || username;
      clubLogo.textContent = p.NombreClub || "Club Rugby";
      descripcionClub.textContent = p.Descripción || "";
      portadaImg.src = p.Portada || "";
      perfilNombre.value = p.NombreClub || "";
      perfilDireccion.value = p.Dirección || "";
      perfilTelefono.value = p.Teléfono || "";
      perfilDescripcion.value = p.Descripción || "";
      perfilWhatsapp.value = p.WhatsApp || "";
      perfilInstagram.value = p.Instagram || "";
      perfilPortada.value = p.Portada || "";

      // Links contacto
      telLink.href = `tel:${p.Teléfono || ""}`;
      whatsappLink.href = `https://wa.me/${p.WhatsApp || ""}`;
      instagramLink.href = `https://instagram.com/${p.Instagram || ""}`;

      // Map
      if (p.Dirección) {
        mapa.src = `https://maps.google.com/maps?q=${encodeURIComponent(p.Dirección)}&output=embed`;
      }
    }

    // 2️⃣ Partidos
    const res2 = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "listarEventos" })
    });
    const rawPartidos = await res2.json();
    console.log("Partidos API:", rawPartidos);

    // Normalizar campos como en partidos.html
    function normalizePartido(raw) {
      const ev = {};
      for (const k in raw) {
        if (!raw.hasOwnProperty(k)) continue;
        const nk = k.toString()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                    .toLowerCase().replace(/\s+/g,'');
        ev[nk] = raw[k];
      }
      return {
        id: ev.id || ev.idevento || ev.id,
        cluborganizador: ev.cluborganizador || '',
        estadoinvitacion: ev.estadoinvitacion || ev.estado || '',
        fecha: ev.fecha || '',
        lugar: ev.lugar || '',
        imagen: ev.imagen || '',
        _raw: raw
      };
    }

    const hoy = new Date();
    const partidosNorm = rawPartidos.map(normalizePartido);

    // Filtrar solo partidos activos
    const partidosFiltrados = partidosNorm.filter(p => {
      const estado = (p.estadoinvitacion || '').toLowerCase();
      const fechaEvento = p.fecha ? new Date(p.fecha) : null;
      return estado === 'aceptado' && (!fechaEvento || fechaEvento >= hoy);
    });

    // Mostrar partidos
    listaPartidos.innerHTML = '';
    if (partidosFiltrados.length === 0) {
      listaPartidos.innerHTML = "<p>No hay partidos activos.</p>";
    } else {
      partidosFiltrados.forEach(part => {
        const div = document.createElement("div");
        div.className = "partido-card";
        div.innerHTML = `
          <img src="${part.imagen || 'https://via.placeholder.com/600x300'}" alt="Partido">
          <div class="partido-info">
            <h3>${part.cluborganizador || 'Club'}</h3>
            <p><strong>Fecha:</strong> ${part.fecha}</p>
            <p><strong>Lugar:</strong> <a href="https://maps.google.com/?q=${encodeURIComponent(part.lugar)}" target="_blank">${part.lugar}</a></p>
          </div>
        `;
        listaPartidos.appendChild(div);
      });
    }

  } catch (err) {
    console.error("Error cargarClub():", err);
    clubName.textContent = "Error cargando club";
    listaPartidos.innerHTML = "<p>Error al cargar partidos.</p>";
  }
}

// Login admin
loginBtn.addEventListener("click", async ()=>{
  const pass = prompt("Ingrese contraseña de admin:");
  if(!pass) return;
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"loginClub", username, password:pass})
    });
    const data = await res.json();
    if(data.status==="ok"){
      alert("Bienvenido Admin");
      desbloquearInputs();
      loggedAsAdmin = true;
    } else alert("Contraseña incorrecta");
  } catch(err){ console.error(err); alert("Error al loguear"); }
});

// Guardar perfil
guardarBtn.addEventListener("click", async ()=>{
  if(!loggedAsAdmin){ alert("Debe iniciar sesión como admin"); return; }
  const perfil = {
    username,
    NombreClub: perfilNombre.value,
    Dirección: perfilDireccion.value,
    Teléfono: perfilTelefono.value,
    Descripción: perfilDescripcion.value,
    WhatsApp: perfilWhatsapp.value,
    Instagram: perfilInstagram.value,
    Portada: perfilPortada.value
  };
  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({action:"actualizarPerfilClub", ...perfil})
    });
    const data = await res.json();
    if(data.status==="ok"){ alert("Perfil guardado correctamente"); portadaImg.src = perfil.Portada; }
    else alert("Error: "+data.msg);
  } catch(err){ alert("Error al guardar: "+err.message); }
});

cargarClub();

// Animaciones al scroll
const sections = document.querySelectorAll("section");
window.addEventListener("scroll", ()=>{
  sections.forEach(sec=>{
    if(sec.getBoundingClientRect().top < window.innerHeight - 100) sec.classList.add("visible");
  });
});
</script>
</body>
</html>
